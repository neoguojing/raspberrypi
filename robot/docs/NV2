================================================================================
                    NAV2 æ ¸å¿ƒèŠ‚ç‚¹ä¾èµ–ä¸æ•°æ®æµå›¾è¡¨ (åŸºäºå½“å‰é…ç½®)
================================================================================

[å±‚çº§ 1: åŸºç¡€è®¾æ–½å±‚] (åº•åº§ï¼šæ²¡å®ƒä»¬ Nav2 èŠ‚ç‚¹ä¼šä¸€ç›´å¡åœ¨ Inactive)
--------------------------------------------------------------------------------
- æ—¶é’Ÿä¿¡å· (/clock): å¿…é¡»ç”±ä»¿çœŸå™¨æä¾› (use_sim_time: true)ã€‚
- åæ ‡å˜æ¢ (TF Tree): 
    * map -> odom     : ç”± SLAM æˆ–å®šä½èŠ‚ç‚¹æä¾›ã€‚
    * odom -> base_link: ç”±åº•ç›˜é©±åŠ¨æˆ–å›ç¯ä»¿çœŸå™¨ (loopback_simulator) æä¾›ã€‚
- ä¼ æ„Ÿå™¨æ•°æ® (/seg/scan): ä½ çš„é…ç½®ä¸­æ‰€æœ‰ Costmap éƒ½è®¢é˜…è¿™ä¸ªè¯é¢˜ã€‚

[å±‚çº§ 2: æ„ŸçŸ¥ä¸åœ°å›¾å±‚] (è¾“å…¥ç«¯)
--------------------------------------------------------------------------------
èŠ‚ç‚¹åç§°              ä¾èµ–çš„è¾“å…¥ (Topics/TF)             è¾“å‡º (ä¾›è°ä½¿ç”¨)
-------------------  ------------------------------  ---------------------------
map_server           ç¡¬ç›˜åœ°å›¾æ–‡ä»¶ (.yaml/.pgm)         /map è¯é¢˜ (ç»™ static_layer)
global_costmap       TF(map->base), /map, /seg/scan  å…¨å±€ä»£ä»·åœ°å›¾ (ç»™ Planner)
local_costmap        TF(odom->base), /seg/scan       å±€éƒ¨ä»£ä»·åœ°å›¾ (ç»™ Controller)
                     /cloud_obstacles (RTAB-Map)
                     /slam3/map_points (SLAM3)

[å±‚çº§ 3: è®¡ç®—æœåŠ¡å™¨å±‚] (é€»è¾‘æ ¸å¿ƒ)
--------------------------------------------------------------------------------
èŠ‚ç‚¹åç§°              ä¾èµ–çš„å±‚çº§/èŠ‚ç‚¹                   åŠŸèƒ½è¯´æ˜
-------------------  ------------------------------  ---------------------------
planner_server       global_costmap                  è®¡ç®—å…¨å±€è·¯å¾„ (GridBased/Dijkstra)
controller_server    local_costmap                   MPPI å±€éƒ¨é¿éšœä¸è·¯å¾„è·Ÿéš
smoother_server      planner_server                  å¹³æ»‘è·¯å¾„ï¼Œå‡å°‘æŠ˜çº¿é¡¿æŒ«
behavior_server      global/local_costmap            æ‰§è¡Œ Spin/Backup ç­‰æ¢å¤è¡Œä¸º
route_server         Graph æ–‡ä»¶ (.geojson)            åŸºäºæ‹“æ‰‘å›¾çš„è·¯å¾„è·¯ç”±

[å±‚çº§ 4: æŒ‡æŒ¥ä¸è°ƒåº¦å±‚] (é¡¶å±‚æ§åˆ¶)
--------------------------------------------------------------------------------
èŠ‚ç‚¹åç§°              ä¾èµ–çš„èŠ‚ç‚¹ (Action Clients)      åŠŸèƒ½è¯´æ˜
-------------------  ------------------------------  ---------------------------
bt_navigator         Planner, Controller, Behavior   è¡Œä¸ºæ ‘å¤§è„‘ï¼ŒæŒ‡æŒ¥æ‰€æœ‰ Server
waypoint_follower    bt_navigator                    å¾ªç¯æ‰§è¡Œå¤šä¸ªèˆªç‚¹ä»»åŠ¡

[å±‚çº§ 5: å®‰å…¨ä¸åå¤„ç†å±‚] (æœ€åä¸€é“é˜²çº¿)
--------------------------------------------------------------------------------
èŠ‚ç‚¹åç§°              ä¾èµ–çš„è¾“å…¥                       è¾“å‡º
-------------------  ------------------------------  ---------------------------
velocity_smoother    controller_server (cmd_vel)     å¹³æ»‘åçš„ cmd_vel (ç»™åº•ç›˜)
collision_monitor    /seg/scan, TF(odom->base)       ç´§æ€¥åˆ¹è½¦æŒ‡ä»¤ (æœ€é«˜ä¼˜å…ˆçº§)

================================================================================
                    é€»è¾‘æµå‘å›¾ (Data & Control Flow)
================================================================================

   [ ä¼ æ„Ÿå™¨/ä»¿çœŸå™¨ ]  --> /seg/scan / /ekf/odom
           |
           v
   +-----------------------+          +------------------------+
   |   local_costmap       |          |    global_costmap      |
   | (ç›¯ä½å‘¨å›´ 4x4m)       |          | (ç›¯ä½ 100x100m å…¨å±€)    |
   +----------+------------+          +-----------+------------+
              |                                   |
              v                                   v
   +-----------------------+          +------------------------+
   |   controller_server   | <------- |    planner_server      |
   | (MPPI é©¾é©¶å‘˜)         | (è·¯å¾„)    | (Dijkstra å¯»è·¯è€…)      |
   +----------+------------+          +-----------+------------+
              |                                   ^
              v                                   |
   +-----------------------+          +------------------------+
   |   velocity_smoother   | <------- |     bt_navigator       |
   | (æ²¹é—¨ç¼“å†²)            | (å‘½ä»¤)    | (è¡Œä¸ºæ ‘å¤§è„‘)            |
   +----------+------------+          +------------------------+
              |
              v
   +-----------------------+
   |   collision_monitor   | (å¼ºåˆ¶åˆ¹è½¦æ£€æŸ¥)
   | (ä¸»åŠ¨å®‰å…¨)            |
   +----------+------------+
              |
              +------> [ æœºå™¨äººç”µæœºæ‰§è¡Œå™¨ ] (/cmd_vel)


[Static Layer]   ---> é™æ€éšœç¢ç‰©
[Obstacle Layer] ---> åŠ¨æ€éšœç¢ç‰©ï¼ˆä¼ æ„Ÿå™¨è§‚æµ‹ï¼‰
[Inflation Layer] ---> å¯¹æ‰€æœ‰éšœç¢ç‰©è†¨èƒ€ç”Ÿæˆç¼“å†²åŒº
             |
             v
      æœ€ç»ˆå±€éƒ¨/å…¨å±€ä»£ä»·åœ°å›¾

================================================================================
æç¤ºï¼šä½ çš„é…ç½®ä¸­å…³é”®ä¾èµ–é¡¹æ˜¯ /seg/scanï¼Œå¦‚æœè¿™ä¸ªè¯é¢˜æ²¡æœ‰æ•°æ®ï¼Œ
æ‰€æœ‰çš„ Costmap éƒ½æ— æ³•è¿›å…¥ Active çŠ¶æ€ã€‚
================================================================================

## Nav2 å…¨æ¨¡å—å‚æ•° Ã— ç°è±¡ å¯¹ç…§æ€»è¡¨

| æ¨¡å—                    | å­æ¨¡å—            | å‚æ•°                    | æ¨èå€¼ / èŒƒå›´     | ä½œç”¨ä¸€å¥è¯   | å¸¸è§å¼‚å¸¸ç°è±¡  | ä¼˜å…ˆè°ƒè¯•æ–¹å‘     |
| --------------------- | -------------- | --------------------- | ------------ | ------- | ------- | ---------- |
| **Local Costmap**     | åŸºç¡€             | width / height        | 6 ~ 8 m      | å±€éƒ¨å¯è§†èŒƒå›´  | å¿«æ’æ‰ååº”   | å¢å¤§å°ºå¯¸       |
| Local Costmap         | åŸºç¡€             | resolution            | 0.05         | å±€éƒ¨åœ°å›¾ç²¾åº¦  | CPU å ç”¨é«˜ | é™ä½ç²¾åº¦       |
| Local Costmap         | åŸºç¡€             | update_frequency      | 10 Hz        | éšœç¢æ›´æ–°é¢‘ç‡  | é¿éšœè¿Ÿé’    | æé«˜é¢‘ç‡       |
| Local Costmap         | åŸºç¡€             | publish_frequency     | 10 Hz        | RViz æ˜¾ç¤º | æ˜¾ç¤ºå¡é¡¿    | é™ä½é¢‘ç‡       |
| Local Costmap         | åæ ‡ç³»            | rolling_window        | true         | åœ°å›¾éšè½¦èµ°   | åœ°å›¾ä¸åŠ¨    | å¿…é¡»å¼€å¯       |
| Local Costmap         | åæ ‡ç³»            | global_frame          | odom         | å±€éƒ¨å‚è€ƒç³»   | TF æŠ–åŠ¨   | æ”¹ä¸º odom    |
| Local Costmap         | åæ ‡ç³»            | robot_base_frame      | base_link    | æœºå™¨äººæœ¬ä½“   | éšœç¢åç§»    | æ ¡æ­£ TF      |
| Local Costmap         | obstacle_layer | topic                 | /scan        | éšœç¢æ¥æº    | æ— éšœç¢     | è¯é¢˜ / frame |
| Local Costmap         | obstacle_layer | obstacle_range        | ~4.0         | æ ‡è®°è·ç¦»    | éšœç¢ç¼ºå¤±    | å¢å¤§         |
| Local Costmap         | obstacle_layer | raytrace_range        | > obstacle   | æ¸…é™¤è·ç¦»    | é¬¼å½±éšœç¢    | å¢å¤§         |
| Local Costmap         | obstacle_layer | marking               | true         | æ ‡è®°éšœç¢    | åœ°å›¾å¾ˆå¹²å‡€   | å¼€å¯         |
| Local Costmap         | obstacle_layer | clearing              | true         | æ¸…éšœ      | éšœç¢æ®‹ç•™    | å¼€å¯         |
| Local Costmap         | inflation      | inflation_radius      | 0.4 ~ 0.6    | ç¦»éšœå®‰å…¨è·   | è´´å¢™èµ°     | å¢å¤§         |
| Local Costmap         | inflation      | cost_scaling_factor   | 2 ~ 4        | ä¿å®ˆç¨‹åº¦    | ä¸æ•¢èµ°çª„è·¯   | é™ä½         |
| **Global Costmap**    | åŸºç¡€             | global_frame          | map          | å…¨å±€å‚è€ƒç³»   | è§„åˆ’æ¼‚ç§»    | æ£€æŸ¥ TF      |
| Global Costmap        | åŸºç¡€             | rolling_window        | false        | å›ºå®šä¸–ç•Œ    | æ¢ç´¢å¤±è´¥    | å¿…é¡»å…³é—­       |
| Global Costmap        | å°ºå¯¸             | width / height        | 40 ~ 80 m    | æ¢ç´¢èŒƒå›´    | æ¢ç´¢åˆ°è¾¹ç•Œåœ  | å¢å¤§         |
| Global Costmap        | å°ºå¯¸             | resolution            | 0.05 ~ 0.1   | å…¨å±€ç²¾åº¦    | å†…å­˜æš´æ¶¨    | é™ä½ç²¾åº¦       |
| Global Costmap        | æœªçŸ¥             | track_unknown_space   | true         | å…è®¸æœªçŸ¥    | æ¢ç´¢ä¸åŠ¨    | å¿…é¡»å¼€å¯       |
| Global Costmap        | obstacle_layer | obstacle_range        | 6.0          | å…¨å±€éšœç¢    | è·¯å¾„ç»•è¿œ    | è°ƒæ•´         |
| Global Costmap        | obstacle_layer | raytrace_range        | 8.0          | æ¸…éšœ      | å…¨å±€æ®‹å½±    | å¢å¤§         |
| **Planner Server**    | æ’ä»¶             | planner_plugins       | NavFn / Smac | è·¯å¾„ç®—æ³•    | æ— è·¯å¾„     | æ¢ NavFn    |
| Planner Server        | ç›®æ ‡             | tolerance             | 0.3 ~ 0.5    | ç»ˆç‚¹å®¹å¿    | ç›®æ ‡ä¸å¯è¾¾   | å¢å¤§         |
| Planner Server        | æœªçŸ¥             | allow_unknown         | true         | æ¢ç´¢è§„åˆ’    | ç›´æ¥å¤±è´¥    | å¿…é¡»å¼€å¯       |
| **Controller Server** | é€Ÿåº¦             | max_vel_x             | 0.2 ~ 0.4    | å‰è¿›é€Ÿåº¦    | ä¸èµ°      | å¢å¤§         |
| Controller Server     | é€Ÿåº¦             | min_vel_x             | 0.0          | æœ€å°å‰è¿›    | åŸåœ°æ‰“è½¬    | è®¾ä¸º 0       |
| Controller Server     | é€Ÿåº¦             | max_vel_theta         | 0.8 ~ 1.2    | è½¬å‘é€Ÿåº¦    | æŠ–åŠ¨      | é™ä½         |
| Controller Server     | DWB            | sim_time              | 1.0 ~ 2.0    | å‰ç»è·ç¦»    | æ’éšœç¢     | å¢å¤§         |
| Controller Server     | DWB            | vx_samples            | ~20          | çº¿é€Ÿåº¦é‡‡æ ·   | è¡Œä¸ºç”Ÿç¡¬    | å¢å¤§         |
| Controller Server     | DWB            | vtheta_samples        | ~40          | è§’é€Ÿåº¦é‡‡æ ·   | è½¬å‘ä¸ç¨³    | å¢å¤§         |
| Controller Server     | Critics        | PathDist / GoalDist   | åŸºç¡€å¿…å¼€         | èƒ½ä¸èƒ½èµ°    | ä¸åŠ¨      | ä¿ç•™         |
| Controller Server     | Critics        | PathAlign / GoalAlign | ä¸­çº§           | å¯¹é½è·¯å¾„    | èµ°æ­ª      | æ·»åŠ          |
| Controller Server     | Critics        | ObstacleFootprint     | é«˜çº§           | ç²¾ç»†é¿éšœ    | æ’éšœç¢     | æ·»åŠ          |

---

## è°ƒè¯•å£è¯€ï¼ˆå·¥ç¨‹å‘ï¼‰

> **å…ˆçœ‹ Costmap åƒä¸åƒä¸–ç•Œ â†’ å†çœ‹ Planner æœ‰æ²¡æœ‰è·¯ â†’ æœ€åè°ƒ Controller è®©è½¦æ•¢èµ°**

---

## è°ƒè¯•é˜¶æ®µæœ€å°å¯ç”¨ç»„åˆï¼ˆç›´æ¥å¯¹ç…§ï¼‰

| æ¨¡å—             | æ ¸å¿ƒè®¾ç½®                            |
| -------------- | ------------------------------- |
| Local Costmap  | 6Ã—6 / 0.05 / obstacle+inflation |
| Global Costmap | 50Ã—50 / track_unknown=true      |
| Planner        | NavFn + tolerance=0.5           |
| Controller     | max_vel_x=0.25 / sim_time=1.5   |

## å®šä½è¿‡è½¦
### TFå®šä½
ros2 run tf2_ros tf2_monitor
ros2 topic echo /tf --qos-durability volatile
ros2 topic echo /tf_static --qos-durability transient_local

ros2 run tf2_tools view_frames

### scanä¼ æ„Ÿå™¨
ros2 topic hz /seg/scan
ros2 topic echo /seg/scan --once

### costmap
ros2 topic hz /local_costmap/costmap
ros2 topic hz /local_costmap/published_footprint
ros2 topic echo /rosout | grep costmap

###planner
ros2 action list | grep Navigate
ros2 action info /navigate_to_pose
ros2 topic echo /plan --once
ros2 topic hz /plan
ros2 topic echo /rosout | grep planner

### controller
ros2 topic echo /cmd_vel
ros2 topic echo /rosout | grep controller
progress_checker:
  plugin: "nav2_controller::SimpleProgressChecker"
  required_movement_radius: 0.01
  movement_time_allowance: 999.0
ğŸ‘‰ å¦‚æœå…³æ‰åèƒ½èµ°
= ä¸æ˜¯ä¼ æ„Ÿå™¨é—®é¢˜ï¼Œæ˜¯â€œèµ°å¾—å¤ªæ…¢è¢«åˆ¤æ­»â€

