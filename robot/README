# 验证两台机器是否能通过多播发现对方（DDS 发现的基础）
ros2 multicast receive  # 在服务器端运行
ros2 multicast send     # 在树莓派端运行，看服务器是否有输出

# 检查节点之间的逻辑连接（查看整个计算图）
ros2 node list
ros2 node info /your_slam_node_name

# 查看所有话题，确认远端话题是否已经出现在列表中
ros2 topic list -t      # -t 会显示话题类型，方便排查

# 查看 CycloneDDS 的当前配置（确认 XML 是否生效）
ros2 doctor --report | grep rmw

# 实时监测网络流量与丢包（需要安装 cyclonedds-tools）
# sudo apt install ros-jazzy-cyclonedds-tools
ros2 run cyclonedds_cpp_tools cyclone_find_topic /camera/image_raw

# 强制刷新发现机制（有时节点重启后没对上，可以用这个查看）
ros2 run cyclonedds_cpp_tools cyclone_list_nodes

# 查看话题的详细 QoS 设置
# 重点检查：Reliability (可靠性) 和 Durability (持久性)
ros2 topic info /camera/image_raw --verbose

# 手动指定 QoS 打印话题（如果对方是 SensorDataQoS，普通 echo 可能没数据）
# 单目视觉和 IMU 通常使用 'sensor_data' 策略
ros2 topic echo /camera/image_raw --qos-profile sensor_data

# 检查消息频率是否稳定（判断 WiFi 是否堵塞）
ros2 topic hz /camera/image_raw    # 图像频率
ros2 topic hz /imu/data            # IMU 频率
ros2 topic bw /camera/image_raw    # 查看实际占用的带宽（Mbps）

# 检查图像消息从树莓派发出到服务器接收的时间延迟
# (前提：两台机器已通过 chrony 进行时间同步)
ros2 topic delay /camera/image_raw

# 查看 TF 树是否完整，以及是否存在过期数据
ros2 run tf2_tools view_frames
# 在 Jazzy 中，建议使用：
ros2 run tf2_ros tf2_monitor

# 仿真环境安装
sudo apt update && sudo apt install curl gnupg lsb-release -y
sudo curl https://packages.osrfoundation.org/gazebo.gpg --output /usr/share/keyrings/pkgs-osr-archive-keyring.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/pkgs-osr-archive-keyring.gpg] http://packages.osrfoundation.org/gazebo/ubuntu-stable $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/gazebo-stable.list > /dev/null

sudo apt update
sudo apt install gz-harmonic

export GZ_PARTITION=sim
gz sim -v 4 shapes.sdf

# 架构
robot(camera)  -> /camera/image_raw or /camera/image_raw/compressed -> slam3 and rtabmap
robot(imu)     -> /imu/data_raw -> slam3 and ekf
slam3   -> /slam3/pose(map) -> 
slam3   -> /slam3/odom(odom->base_link) -> ekf
slam3   -> /slam3/map_points -> rtabmap,nv2(local_costmap.obstacle_layer,local_costmap.voxel_layer,global_costmap.obstacle_layer,collision_monitor)
slam3   -> /slam3/debug_image -> foxglove or ?
slam3   -> tf(map->odm) -> 
ekf     -> /ekf/tf(?) -> nv2
ekf     -> /ekf/tf_static(?) -> 
ekf     -> /ekf/odom(?) -> nv2(bt_navigator.odom_topic)
rtabmap -> /map -> nv2
nv2(collision_monitor) -> cmd_vel -> robot
robot     -> /camera/camera_info -> rtabmap

robot (camera) --> /camera/image_raw (sensor_msgs/Image) + /camera/camera_info (sensor_msgs/CameraInfo)
robot (camera) --> /camera/image_raw/compressed  (optional - image_transport)

robot (imu)    --> /imu/data_raw (sensor_msgs/Imu)

# ORB-/SLAM3 节点（视觉里程计 +地图特征）
slam3 (ORB-SLAM3) --
    subscribes: /camera/image_raw, /camera/camera_info, /imu/data_raw (if visual-inertial)
    publishes:
        /slam3/pose             (geometry_msgs/PoseStamped)   frame_id: map
        /slam3/odom             (nav_msgs/Odometry)           odom->base_link
        /slam3/map_points       (sensor_msgs/PointCloud2)     （供可视化或稠密化）
        /slam3/debug_image      (sensor_msgs/Image)           debug visualization (Foxglove)
    broadcasts:
        TF: map -> map -> odom

# robot_localization (EKF) — 融合 IMU + slam3/odom
ekf_localization_node --
    subscribes: /imu/data_raw, /slam3/odom
    publishes:
        /odometry/filtered     (nav_msgs/Odometry)         frame_id: odom (-> base_link)
    broadcasts:
        TF: odom -> base_link

# Nav2 (导航堆栈)
nav2 (bt_navigator, planner_server, controller_server, costmap) --
    subscribes:
        /map  (来自 rtabmap)
        odom topic (set 为 /odometry/filtered 或 /odom)
        sensor topics for obstacle_layer (e.g. /scan, /points)
    publishes:
        cmd_vel -> robot base controller (geometry_msgs/Twist)
    uses tf: map -> odom, odom -> base_link, base_link -> sensors

# collision_monitor (Nav2 或自定义)
collision_monitor --
    subscribes: rtabmap pointclouds 或 local_costmap topics
    triggers safety stops / emergency behaviors -> cmd_vel (or into Nav2 lifecycle)


# RTAB-Map 用于生成导航地图（占领网格 / 点云）
# 废弃，无法使用单目相机生成地图
rtabmap --
    subscribes: /camera/image_raw, /camera/camera_info, optionally /slam3/pose or /odom
    publishes:
        /map                    (nav_msgs/OccupancyGrid) or /rtabmap/grid_map
        /rtabmap/points         (sensor_msgs/PointCloud2) (map points / obstacles)
    note: 如果你用 SLAM3 做定位，RTAB-Map 可仅负责稠密重建 / 占用网格生成。