# =============================================================================
# 系统生命周期管理：确保节点按顺序启动
# =============================================================================
lifecycle_manager:
  ros__parameters:
    autostart: true
    node_names: ['map_server', 'planner_server', 'controller_server', 
                 'behavior_server', 'bt_navigator', 'velocity_smoother', 
                 'collision_monitor']

# =============================================================================
# 规划器：寻找全局最优路径
# =============================================================================
planner_server:
  ros__parameters:
    expected_planner_frequency: 5.0
    planner_plugins: ["GridBased"]
    GridBased:
      plugin: "nav2_navfn_planner::NavfnPlanner"
      tolerance: 0.5
      use_astar: false  # A* 在低算力平台上更快
      allow_unknown: true

# =============================================================================
# 控制器：实时避障与路径跟随 (MPPI 极致优化版)
# =============================================================================
controller_server:
  ros__parameters:
    controller_frequency: 10.0 # 降低频率减轻树莓派负担
    min_x_velocity_threshold: 0.001
    min_theta_velocity_threshold: 0.001
    controller_plugins: ["FollowPath"]
    FollowPath:
      plugin: "nav2_mppi_controller::MPPIController"
      time_steps: 30          # 预测时间步长缩短
      model_dt: 0.1
      batch_size: 400         # 关键：从2000降至400，防止CPU炸满
      vx_max: 0.5
      vx_min: -0.2
      wz_max: 1.0
      iteration_count: 1
      visualize: false        # 树莓派必须关闭可视化
      motion_model: "DiffDrive"
      critics: ["ConstraintCritic", "CostCritic", "GoalCritic", "PathAlignCritic"]
      CostCritic:
        cost_weight: 5.0
        critical_cost: 300.0

# =============================================================================
# 局部代价地图：实时障碍物识别 (接收 PointCloud2)
# =============================================================================
local_costmap:
  local_costmap:
    ros__parameters:
      update_frequency: 5.0
      publish_frequency: 2.0
      global_frame: odom      # 需确保 ORB-SLAM3 发布 map->odom
      robot_base_frame: base_link
      rolling_window: true
      width: 2.5              # 缩小范围减少计算量
      height: 2.5
      resolution: 0.05
      robot_radius: 0.22
      plugins: ["voxel_layer", "inflation_layer"]
      voxel_layer:
        plugin: "nav2_costmap_2d::VoxelLayer"
        enabled: True
        observation_sources: pointcloud_src
        pointcloud_src:
          topic: /slam3/map_points # 替换为你 ORB-SLAM3 发布的点云话题
          data_type: "PointCloud2"
          min_obstacle_height: 0.1 # 过滤地面噪点
          max_obstacle_height: 1.8
          clearing: True
          marking: True
      inflation_layer:
        plugin: "nav2_costmap_2d::InflationLayer"
        inflation_radius: 0.5

# =============================================================================
# 全局代价地图：宏观环境感知
# =============================================================================
global_costmap:
  global_costmap:
    ros__parameters:
      update_frequency: 1.0
      publish_frequency: 1.0
      global_frame: map
      robot_base_frame: base_link
      robot_radius: 0.22
      resolution: 0.05
      plugins: ["static_layer", "obstacle_layer", "inflation_layer"]
      obstacle_layer:
        plugin: "nav2_costmap_2d::ObstacleLayer"
        observation_sources: pointcloud_src
        pointcloud_src:
          topic: /slam3/map_points
          data_type: "PointCloud2"
          clearing: True
          marking: True
      static_layer:
        plugin: "nav2_costmap_2d::StaticLayer"
        map_subscribe_transient_local: True

# =============================================================================
# 行为树导航：任务调度
# =============================================================================
bt_navigator:
  ros__parameters:
    global_frame: map
    robot_base_frame: base_link
    odom_topic: /slam3/odom
    navigators: ["navigate_to_pose"]

# =============================================================================
# 碰撞监控：底层保护
# =============================================================================
collision_monitor:
  ros__parameters:
    base_frame_id: "base_link"
    odom_frame_id: "odom"
    cmd_vel_in_topic: "cmd_vel_smoothed"
    cmd_vel_out_topic: "cmd_vel"
    polygons: ["FootprintApproach"]
    FootprintApproach:
      type: "polygon"
      action_type: "approach"
      time_before_collision: 1.0
    observation_sources: ["pointcloud_scan"]
    pointcloud_scan:
      type: "pointcloud"
      topic: "/slam3/map_points"
      min_height: 0.1
      max_height: 1.8

# =============================================================================
# 冗余组件简化
# =============================================================================
velocity_smoother:
  ros__parameters:
    max_velocity: [0.5, 0.0, 1.0]
    max_accel: [1.0, 0.0, 1.0]

map_server:
  ros__parameters:
    yaml_filename: "map.yaml"

behavior_server:
  ros__parameters:
    behavior_plugins: ["spin", "backup", "wait"]