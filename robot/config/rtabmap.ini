; ===============================
; RTAB-Map 单目 + 外部里程计 配置
; ===============================

[Core]
Rtabmap/ImagesAlreadyRectified=false
Rtabmap/ImageBufferSize=5
Rtabmap/MemoryThr=0.0
Rtabmap/StartNewMapOnGoodSignature=true

[Rtabmap]
Rtabmap/LoopThr=0.25
Rtabmap/LoopRatio=0.6
Rtabmap/LoopClosureReextractFeatures=true
Rtabmap/LocalBundleOnLoopClosure=true
Rtabmap/OptimizeFromGraphEnd=true

[RGBD]
RGBD/Enabled=false                ; ❗ 单目
RGBD/ForceOdom3DoF=true
RGBD/CreateOccupancyGrid=false
RGBD/LinearUpdate=0.1
RGBD/AngularUpdate=0.05
RGBD/LinearSpeedUpdate=0.2
RGBD/AngularSpeedUpdate=0.1

[Mem]
Mem/STMSize=50
Mem/IncrementalMemory=true
Mem/NotLinkedNodesKept=true
Mem/UseOdomFeatures=true          ; ✔ 单目 + 外部 odom 非常关键

[Vis]
Vis/FeatureType=0                 ; ORB
Vis/MaxFeatures=1500
Vis/MinDepth=0
Vis/MaxDepth=5.0
Vis/SubPixIterations=5
Vis/SubPixWinSize=5
Vis/SubPixEps=0.01
Vis/InlierDistance=0.1
Vis/Iterations=200
Vis/PnPFlags=1
Vis/RefineIterations=5

[Kp]
Kp/DetectorStrategy=0
Kp/MaxFeatures=1500

[ORB]
ORB/NLevels=8
ORB/ScaleFactor=1.2
ORB/EdgeThreshold=31
ORB/WTA_K=2
ORB/PatchSize=31

[Optimizer]
Optimizer/Iterations=20
Optimizer/Robust=true
Optimizer/GravitySigma=0.3
Optimizer/Epsilon=1e-5

[ImuFilter]
ImuFilter/ComplementaryDoBiasEstimation=true
ImuFilter/ComplementaryGainAcc=0.02
ImuFilter/ComplementaryBiasAlpha=0.005

[Reg]
; 0=Vis, 1=Icp, 2=VisIcp. 
; 如果 Scan 质量好，建议用 1 或 2 进行位姿精修
Reg/Strategy=0                  ; 单目通常以 Vis 为主，Scan 仅用于建图
Reg/Force3DoF=false              ; 室内机器人强制 3 自由度

[Grid]
; 核心：告诉 RTAB-Map 从 Scan 话题创建 2D 地图
Grid/FromDepth=false            
Grid/RangeMax=4.0              ; 模拟 Scan 的有效距离
Grid/CellSize=0.05              ; 地图分辨率 5cm
Grid/MaxObstacleHeight=1.5      ; 障碍物高度阈值
Grid/RayTracing=true            ; 开启射线追踪以清理地图
Grid/Sensor=0

[Icp]
; 如果 Reg/Strategy 选了 1 或 2，则需要配置 ICP
Icp/VoxelSize=0.05
Icp/CorrespondenceRatio=0.3
